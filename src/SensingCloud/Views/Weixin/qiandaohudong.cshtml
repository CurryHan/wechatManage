@model Sensing.Entities.Weixin.WeixinUserAction
@{
    ViewBag.Title = "大乱聊之" + Model.Activity.Name;
    Layout = "~/Views/Shared/_ActionLayout.cshtml";
}

@section styles{
    <link href="~/content/game/css/swiper.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="~/Content/action/qiandaohudong.css" />
}


<script>
        window.onload=function()
        {
            var innerheght = $(window).height();
            bodyheigt=$("body").height();
            $("body").height(innerheght);
        }
        var HEIGHTmain = $('body').height();
        $(window).resize(function() {
            $('.main').height(HEIGHTmain);
        });


        var lastmessageid="";
        setInterval('doGetMessage()',1000);
        $(function () {
            $('#myForm').on('submit', function () {
                doPostMessage();
                return false;
            });
        });

        function doPostMessage() {
            if($('#message').val().trim()=="")
            {
                $("#msg").html("发送内容不能为空！");
            }else{
                var options = {
                    method: 'post',
                    data: $('#myForm').serialize(),
                    url: "/Weixin/PostMessage"
                };
                $.ajax(options).success(function (data) {
                    if (data.status = "ok") {
                        $('#message').val("");
                        doGetMessage();
                        $("#msg").html("");
                    }
                    else {
                        $("#msg").html("抱歉发送失败");
                    }
                }).fail(function (jqXHR, status, error) {
                    console.log(error);
                });}
        }

        function doGetMessage() {
            var options = {
                method: 'get',
                data: {"activityID":@Model.ActivityID},
                url: "/Weixin/GetMessage"
            };
            $.ajax(options).success(function (data) {
                if (data.status = "ok") {
                    showMessage(data);
                }
                else {
                    $("#msg").html("抱歉获取内容失败");
                }
            }).fail(function (jqXHR, status, error) {
                console.log(error);
            });
        }

        function showMessage(response)
        {
            $(".swiper-slide").html("");
            var _tempmessageid="";
            for(var i = 0;i<response.data.length;i++)
            {
                var data = response.data[i];
                var _tempid=data.UserID;
                var userid=@Model.WeixinUserInfoID;
                if(_tempid==userid)
                {
                    $(".swiper-slide").append('<div class="userchattingdiv">'
                            +'<div style="width: 50px;height: 50px;float: right;position: relative">'
                                +'<img src="../content/weixinimage/nianhuiimg/quan.png" style="width: 100%;height: 100%;position: absolute;z-index: -1;">'
                                +'<img src="'+ data.headImg +'" style="width: 80%;height: 80%;position: absolute;z-index: -1;border-radius: 50%;left: 10%;top:10%;"></div>'
                            +'<div style="position: relative;width: 50%;height: 20px;float: right;margin-right: 20px;color: #fff8e8;font-size: 12px;text-align: right">'
                                +'<span>'+data.userName+'</span></div>'
                            +'<div class="pos_relright"><span class="icon2"></span><div style="width: 70%;float:right"><div class="talkdiv_right">'
                            +'<label>'+data.message+'</label></div></div></div></div>');
                }else
                {
                    $(".swiper-slide").append('<div class="userchattingdiv">'
                    +'<div style="width: 50px;height: 50px;float: left;position: relative">'
                    +'<img src="../content/weixinimage/nianhuiimg/quan.png" style="width: 100%;height: 100%;position: absolute;z-index: -1;">'
                    +'<img src="'+ data.headImg +'" style="width: 80%;height: 80%;position: absolute;z-index: -1;border-radius: 50%;left: 10%;top:10%;"></div>'
                    +'<div style="position: relative;width: 50%;height: 20px;float: left;margin-left: 20px;color: #fdf1c0;font-size: 12px;">'
                    +'<span>'+data.userName +'</span></div><div class="pos_rel"><span class="icon2">'
                    +'</span><div style="width: 70%"><div class="talkdiv"><label>'+data.message+'</label></div></div></div></div>');
                }
                _tempmessageid=data.messageId;
            }
            //更新swiper
            swiper.update();
            if(lastmessageid!=_tempmessageid)
            {
                //滚动
                var h = (-$('.swiper-slide').height()+$('.swiper-container').height())+"px";
                console.log(h);
                $('.swiper-wrapper').css("transform","translate3d(0px, "+h+", 0px)");
            }
            lastmessageid=_tempmessageid
        }

</script>

<div class="bg">
    <div class="titlediv">
        <img src="~/content/weixinimage/nianhuiimg/TitleImg.png" class="titleimg">
        <div style="width: 100%;height: auto;text-align: center;margin-top: -15px;">
            <img src="~/content/weixinimage/nianhuiimg/yun.png" style="width: 65%;">
        </div>
    </div>
    <div class="chattingcontentdiv">
        <div class="swiper-container">
            <div class="swiper-wrapper">
                <div class="swiper-slide">


                </div>
            </div>
            <!-- Add Scroll Bar -->
            <div class="swiper-scrollbar"></div>
        </div>
    </div>
    <div class="footdiv">
        <div id="msg" style="color:black;font-size:12px;text-align:center;"></div>
        <div style="width: 100%;">
            <div class="shurudiv">
                <div class="lineDiv">
                    <img src="~/content/weixinimage/nianhuiimg/tk.png" class="inputimg">
                    <form id="myForm">
                        @Html.HiddenFor(model => model.WeixinUserInfoID)
                        @Html.HiddenFor(model => model.GameID)
                        @Html.HiddenFor(model => model.Scene_id)
                        @Html.HiddenFor(model => model.ActivityID)
                        <input type="text" name="message" id="message" class="inputtext" />
                        <img src="~/content/weixinimage/nianhuiimg/fs.png" class="fasongimg" onclick="doPostMessage()">
                    </form>
                    @*<input type="text" class="inputtext">
                        <img src="~/content/weixinimage/nianhuiimg/fs.png" class="fasongimg">*@
                </div>
            </div>
        </div>
        <img src="~/content/weixinimage/nianhuiimg/TitleImg.png" class="footimg">
    </div>
</div>

<script>
    var swiper = new Swiper('.swiper-container', {
        scrollbar: '.swiper-scrollbar',
        scrollbarHide:true,
        direction: 'vertical',
        slidesPerView: 'auto',
        mousewheelControl: true,
        freeMode: true,
        //observer:false,//修改swiper自己或子元素时，自动初始化swiper
        //observeParents:false,//修改swiper的父元素时，自动初始化swiper
    });
</script>