var res={bg_png:"res/bg.png",fore_png:"res/fore.png",main_png:"res/main.png",main_plist:"res/main.plist",introduction_png:"res/introduction.png",bgMusic_wma:"res/Music/bgMusic.mp3"},g_mainmenu=[res.bg_png,res.fore_png,res.main_png,res.main_plist,res.introduction_png,res.bgMusic_wma],g_maingame=[],MW=MW||{};MW.SOUND=!0,MW.UNIT_TAG={QRCODE:900,PLAYER:900,BALLON:1e3,CURSOR:1001},MW.CONTAINER={BALLONS:[],CURSORS:[],EXPLOSIONS:[]},MW.ACTIVE_BALLONS=0,MW.ACTIVE_MAX_BALLONS=30,MW.ACTIVE_CURSORS=0,MW.MAX_CURSORS=4,MW.GAMETIME=60,MW.PLAYERSCOUNT=0,MW.CursorPositionX=800,MW.CursorPositionY=500;var BallonType=[{type:1,textureName:"ballon-1.png"},{type:2,textureName:"ballon-2.png"},{type:3,textureName:"ballon-3.png"},{type:4,textureName:"ballon-4.png"},{type:5,textureName:"ballon-5.png"}],CursorType=[{type:1,textureName:"cursor-1.png"},{type:2,textureName:"cursor-2.png"},{type:3,textureName:"cursor-3.png"},{type:4,textureName:"cursor-4.png"}],Ballon=cc.Sprite.extend({active:!0,zOrder:1e3,ballonType:null,delayTime:1,perX:0,offX:0,ampX:0,velY:0,sX:0,sY:0,_rotation:0,ctor:function(e){this._super(),this.ballonType=e.type,this.setSpriteFrame(e.textureName)},reset:function(){this.setPosition(Math.random()*cc.visibleRect.width,-this.height+1),this.setRotation(0)},update:function(){var e=this.getPosition(),t=e.x,i=e.y;if((t<-this.width||t>cc.winSize.width+this.width||i>cc.winSize.height+this.height||i<-this.height)&&this.destory(),this.active){i<0&&(i=200*Math.random(),this.perX=(1+2*Math.random())*cc.winSize.width,this.offX=Math.random()*cc.winSize.width,this.ampX=.1*this.perX*(.15+Math.random()),this.velY=2*Math.random()+1,this.sX=this.sY=.5*Math.random()+.8,this._rotation=40*Math.random()-20);var r=(this.offX+(cc.winSize.height-i))/this.perX*Math.PI*2,i=i+this.velY*this.sX*200,t=t+Math.cos(r)*this.ampX,n=5*Math.sin(r),a=cc.MoveTo.create(2,cc.p(t,i)),o=cc.RotateBy.create(2,n);this.runAction(cc.Spawn.create(a,o))}},destory:function(){this.setVisible(!1),this.active=!1,MW.ACTIVE_BALLONS--,this.stopAllActions(),this.unschedule(this.update);var e=Explosion.getOrCreateExplosion();e.setPosition(this.getPosition())}});Ballon.create=function(e){var t=new Ballon(e);return g_sharedflyLayer.addBallon(t,t.zOrder,MW.UNIT_TAG.BALLON),MW.CONTAINER.BALLONS.push(t),t},Ballon.getOrCreateBallon=function(e){for(var t=null,i=0;i<MW.CONTAINER.BALLONS.length;i++)if(t=MW.CONTAINER.BALLONS[i],0==t.active&&t.ballonType==e.type)return t.setVisible(!0),t.active=!0,t.reset(),t.schedule(t.update,2),MW.ACTIVE_BALLONS++,t;return t=Ballon.create(e),t.reset(),t.schedule(t.update,2),MW.ACTIVE_BALLONS++,t},Ballon.preSet=function(){for(var e=null,t=0;t<5;t++)for(var i=0;i<BallonType.length;i++)e=Ballon.create(BallonType[i]),e.setVisible(!1),e.active=!1,e.stopAllActions(),e.unscheduleAllCallbacks()};var Cursor=cc.Layer.extend({active:!0,delayTime:1,Score:0,lbScore:null,lbTime:null,cursorType:null,remainTime:0,zOrder:1001,openid:"",_bg:null,_headImage:null,_animation:null,IsPlay:!1,subscriptionKey:"",init:function(e){var t=!1;if(this._super()){this.cursorType=e.type;var i=cc.spriteFrameCache.getSpriteFrame(e.textureName);this._bg=cc.Sprite.create(i),this._bg.setAnchorPoint(.5,.5),this.addChild(this._bg,0,1),this.lbScore=cc.LabelTTF.create("0","Arial Bold",20),this.lbScore.setAnchorPoint(1,0),this.lbScore.setColor(cc.color(255,255,255)),this.lbScore.setHorizontalAlignment(cc.TEXT_ALIGNMENT_RIGHT),this.addChild(this.lbScore,0,2),this.lbScore.setPosition(80,15),this.lbTime=cc.LabelTTF.create("","Arial Bold",20),this.lbTime.setAnchorPoint(1,0),this.lbTime.setColor(cc.color(168,100,70)),this.lbTime.setHorizontalAlignment(cc.TEXT_ALIGNMENT_RIGHT),this.addChild(this.lbTime,0,3),this.lbTime.setPosition(36,78),this._animation=cc.animationCache.getAnimation("CursorShoot"+e.type),t=!0}return t},reset:function(e){this.setTag(e.actionid),this.Score=0,this.subscriptionKey=e.subscriptionKey,this.remainTime=MW.GAMETIME,this.openid=e.openid,this._headImage=e.headImage2,this.addChild(this._headImage,0,4),this._headImage.setPosition(22,43)},update:function(){if(this.remainTime--,this.lbTime.setString(this.remainTime+"s"),this.remainTime<=0){this.destroy();var e="{ActionId:"+this.getTag()+",Score:"+this.Score+"}";PlayerGameOver(e)}},destroy:function(){this.active&&(this.setVisible(!1),this.active=!1,this.stopAllActions(),this._bg.stopAllActions(),this.unschedule(this.update),MW.ACTIVE_CURSORS--,g_sharedflyLayer.removePlayer(this.getTag()),g_sharedflyLayer.SortRank())},addScore:function(){this.Score++,this.lbScore.setString(this.Score)},play:function(){this.IsPlay=!0;var e=cc.Animate.create(this._animation).repeatForever();this._bg.runAction(e)}});Cursor.sharedCursorShoot=function(){for(var e=1;e<MW.MAX_CURSORS+1;e++){var t=[];t.push(cc.spriteFrameCache.getSpriteFrame("cursor-"+e+".png")),t.push(cc.spriteFrameCache.getSpriteFrame("cursor-shoot-"+e+".png"));var i=cc.Animation.create(t,.3);cc.animationCache.addAnimation(i,"CursorShoot"+e)}},Cursor.create=function(e){var t=new Cursor;return t&&t.init(e)?(g_sharedflyLayer.addCursor(t,t.zOrder,MW.UNIT_TAG.CURSOR),MW.CONTAINER.CURSORS.push(t),t):null},Cursor.getOrCreateCursor=function(e){for(var t=null,i=0;i<MW.CONTAINER.CURSORS.length;i++)if(t=MW.CONTAINER.CURSORS[i],0==t.active&&t.cursorType==e.type)return t.reset(e),t.schedule(t.update,t.delayTime),t.setVisible(!0),t.active=!0,MW.ACTIVE_CURSORS++,t;return t=Cursor.create(CursorType[e.type]),t.reset(e),MW.ACTIVE_CURSORS++,t},Cursor.preSet=function(){for(var e=null,t=0;t<3;t++)for(var i=0;i<CursorType.length;i++)e=Cursor.create(CursorType[i]),e.setVisible(!1),e.active=!1,e.stopAllActions(),e.unscheduleAllCallbacks()};var Player=cc.Layer.extend({rank:1,Score:0,lbScore:null,timer:60,openid:"",nickname:null,Award:0,lbAward:null,lbRank:null,zOrder:900,_headImage:null,init:function(e){var t=!1;if(this._super()){this.openid=e.openid,this.width=264,this.height=139;var i=cc.spriteFrameCache.getSpriteFrame("player.png"),r=cc.Sprite.create(i);r.setAnchorPoint(0,0),this.addChild(r,0,1),this.lbScore=cc.LabelTTF.create("0","Arial Bold",20),this.lbScore.setAnchorPoint(1,0),this.lbScore.setColor(cc.color(255,255,255)),this.lbScore.setHorizontalAlignment(cc.TEXT_ALIGNMENT_RIGHT),this.addChild(this.lbScore,0,2),this.lbScore.setPosition(158,20),this.lbAward=cc.LabelTTF.create("0","Arial Bold",20),this.lbAward.setAnchorPoint(1,0),this.lbAward.setColor(cc.color(255,255,255)),this.lbAward.setHorizontalAlignment(cc.TEXT_ALIGNMENT_RIGHT),this.addChild(this.lbAward,0,3),this.lbAward.setPosition(220,20),this._headImage=e.headImage,this.addChild(this._headImage,0,4),this._headImage.setPosition(87,33),this.nickname=cc.LabelTTF.create(e.nickname,"res/fonts/SOURCEHANSANSCN-NORMAL_0.OTF",22),this.addChild(this.nickname,0,5),this.nickname.setPosition(152,70),this.nickname.setColor(cc.color(255,146,146)),this.rank=MW.PLAYERSCOUNT+1,this.lbRank=cc.LabelTTF.create(this.rank,"Arial Bold",20),this.addChild(this.lbRank,0,6),this.lbRank.setPosition(40,30),t=!0}return t},addScore:function(){this.Score++,this.lbScore.setString(this.Score)},addAward:function(){this.Award++,this.lbAward.setString(this.Award)},updateRank:function(e){this.rank=e,this.lbRank.setString(e)}});Player.create=function(e){var t=new Player;return t&&t.init(e)?(console.log(MW.PLAYERSCOUNT),t.setPosition(26,cc.winSize.height-(MW.PLAYERSCOUNT*t.height+288)),MW.PLAYERSCOUNT++,g_sharedflyLayer.addPlayer(t,t.zOrder,e.actionid),t):null};var SysMenu=cc.Layer.extend({_introduction:null,_direction:1,init:function(){var e=!1;if(this._super()){winSize=cc.director.getWinSize();var t=cc.Sprite.create(res.bg_png);t.setAnchorPoint(0,0),this.addChild(t,0,1);var i=cc.Sprite.create(res.fore_png);i.setAnchorPoint(0,0),this.addChild(i,0,1),_introduction=cc.Sprite.create(res.introduction_png),_introduction.setAnchorPoint(.5,1),_introduction.setPosition(cc.winSize.width/2,cc.winSize.height-10),this.addChild(_introduction,0,1),this.schedule(this.update,2),this.addChild(Ballonflylayer.create()),e=!0}return e},update:function(){var e=cc.winSize.width-_introduction.width/2,t=_introduction.width/2+.15*cc.winSize.width;_introduction.getPosition().x>=t?this._direction=-1*this._direction:_introduction.getPosition().x<e&&(this._direction=-1*this._direction),_introduction.runAction(cc.MoveBy.create(2,cc.p(.1*cc.winSize.width*this._direction,0)))}});SysMenu.create=function(){var e=new SysMenu;return e&&e.init()?e:null},SysMenu.scene=function(){var e=cc.Scene.create(),t=SysMenu.create();return e.addChild(t),e};var g_sharedflyLayer,Ballonflylayer=cc.Layer.extend({_maxBallonCount:20,_rankBoard:null,_explosions:null,init:function(){var e=!1;return this._super()&&(this._rankBoard=Rankboard.create(),this.addChild(this._rankBoard),this._explosions=cc.Sprite.create(),this._explosions.setBlendFunc(cc.SRC_ALPHA,cc.ONE),this.addChild(this._explosions),Explosion.sharedExplosion(),Cursor.sharedCursorShoot(),g_sharedflyLayer=this,Ballon.preSet(),Cursor.preSet(),Explosion.preSet(),this.schedule(this.update,1),this.schedule(this.checkIsExposion,.1),MW.SOUND&&cc.audioEngine.playMusic(res.bgMusic_wma,!0),e=!0),e},update:function(){for(var e=5*Math.random()>>0,t=0;t<e;t++)if(MW.ACTIVE_BALLONS<MW.ACTIVE_MAX_BALLONS){var i=Math.random()*BallonType.length>>0;Ballon.getOrCreateBallon(BallonType[i])}},checkIsExposion:function(){for(var e=0;e<MW.CONTAINER.BALLONS.length;e++)for(var t=0;t<MW.CONTAINER.CURSORS.length;t++){var i=MW.CONTAINER.BALLONS[e],r=MW.CONTAINER.CURSORS[t];if(i.active&&r.active&&r.IsPlay){var n=i.getPosition(),a=r.getPosition(),o=a.x-34,s=a.y-22;if(o>n.x-i.width/2&&o<n.x+i.width/2&&s>n.y-i.height/2&&s<n.y+i.height/2){i.destory();var c=g_sharedflyLayer.getPlayer(r.getTag());c.addScore(),r.addScore(),g_sharedflyLayer.SortRank()}}}}});Ballonflylayer.create=function(){var e=new Ballonflylayer;return e&&e.init()?e:null},Ballonflylayer.prototype.addExplosions=function(e){this._explosions.addChild(e)},Ballonflylayer.prototype.addBallon=function(e,t,i){this.addChild(e,t,i)},Ballonflylayer.prototype.addPlayer=function(e,t,i){this._rankBoard.addChild(e,t,i)},Ballonflylayer.prototype.getPlayer=function(e){return this._rankBoard.getChildByTag(e)},Ballonflylayer.prototype.removePlayer=function(e){this._rankBoard.removeChildByTag(e,!0),MW.PLAYERSCOUNT--},Ballonflylayer.prototype.addCursor=function(e,t,i){this.addChild(e,t,i)},Ballonflylayer.prototype.removeCursor=function(e){var t=this.getChildByTag(e);t.destroy()},Ballonflylayer.prototype.getCursor=function(e){var t=this.getChildByTag(e);return t},Ballonflylayer.prototype.PlayerIn=function(e){cc.loader.loadImg(e.headImgUrl,{isCrossOrigin:!0},function(t,i){if(!t){var r=new cc.Texture2D;r.initWithElement(i),r.handleLoadedTexture();var n=new cc.Sprite(r);n.setScale(50/n.width,50/n.height);var a=cc.DrawNode.create();a.drawCircle(cc.p(0,0),25,0,128,!1,1,cc.color(255,255,255,255));var o=cc.ClippingNode.create(a);o.setAlphaThreshold(.05),o.addChild(n),e.headImage=o,Player.create(e),e.type=Math.random()*CursorType.length+1>>0;var s=new cc.Texture2D;s.initWithElement(i),s.handleLoadedTexture();var c=new cc.Sprite(s);c.setScale(62/c.width,62/c.height);var l=cc.DrawNode.create();l.drawCircle(cc.p(0,0),30,0,128,!1,1,cc.color(255,255,255,255));var h=cc.ClippingNode.create(l);h.setAlphaThreshold(.05),h.addChild(c),e.headImage2=h;var d=Cursor.getOrCreateCursor(e);d.setPosition(MW.CursorPositionX*Math.random(),MW.CursorPositionY)}})},Ballonflylayer.prototype.SortRank=function(){var e=this._rankBoard.getChildren(),t=e.slice(1);t.sort(function(e,t){return e.Score<t.Score?1:-1});for(var i=0;i<t.length;i++){var r=t[i];i+1!=r.rank&&(r.updateRank(i+1),r.runAction(cc.MoveTo.create(1,cc.p(26,cc.winSize.height-(i*r.height+288)))))}},Ballonflylayer.prototype.StartGame=function(e){var t=this.getChildByTag(e);t.play()};var Rankboard=cc.Layer.extend({init:function(){var e=!1;if(this._super()){e=!0;var t=cc.spriteFrameCache.getSpriteFrame("board.png"),i=cc.Sprite.create(t);i.setAnchorPoint(0,1),i.setPosition(0,cc.winSize.height),this.addChild(i,0,1)}return e}});Rankboard.create=function(){var e=new Rankboard;return e&&e.init()?e:null};var Explosion=cc.Sprite.extend({tmpWidth:0,tmpHeight:0,active:!0,animation:null,ctor:function(){this._super();var e=cc.spriteFrameCache.getSpriteFrame("explosion1.png");this.setSpriteFrame(e),this.setBlendFunc(cc.SRC_ALPHA,cc.ONE);var t=this.getContentSize();this.tmpWidth=t.width,this.tmpHeight=t.height,this.animation=cc.animationCache.getAnimation("Explosion")},play:function(){this.runAction(cc.Sequence.create(cc.Animate.create(this.animation),cc.CallFunc.create(this.destroy,this)))},destroy:function(){this.setVisible(!1),this.active=!1}});Explosion.sharedExplosion=function(){for(var e=[],t="",i=1;i<4;i++){t="explosion"+i+".png";var r=cc.spriteFrameCache.getSpriteFrame(t);e.push(r);var n=cc.Animation.create(e,.04);cc.animationCache.addAnimation(n,"Explosion")}},Explosion.getOrCreateExplosion=function(){for(var e=null,t=0;t<MW.CONTAINER.EXPLOSIONS.length;t++){var e=MW.CONTAINER.EXPLOSIONS[t];if(0==e.active)return e.setVisible(!0),e.active=!0,e.play(),e}return e=Explosion.create(),e.play(),e},Explosion.create=function(){var e=new Explosion;return g_sharedflyLayer.addExplosions(e),MW.CONTAINER.EXPLOSIONS.push(e),e},Explosion.preSet=function(){for(var e=null,t=0;t<6;t++)e=Explosion.create(),e.setVisible(!1),e.active=!1};var JsResult=function(e,t,i){var r="http://wx.troncell.com/api/v1/WeixinApi/PostDataByUser",n={method:"post",data:{subscriptionKey:i,gameNo:40,clientUniueId:"111",actionId:e,score:t}};$.ajax(r,n).success(function(e){console.log(e.data.Score)}).error(function(e){console.log("error")})};